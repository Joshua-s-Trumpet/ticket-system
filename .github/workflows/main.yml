name: Build and Tag Docker Image

on:
    push:
        branches:
            - '**'

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
            uses: actions/checkout@v2

        - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1

        # - name: Log in to Docker Hub
        #     uses: docker/login-action@v1
        #     with:
        #         username: ${{ secrets.DOCKER_USERNAME }}
        #         password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Extract branch name
            id: extract_branch
            run: echo "::set-output name=branch::$(echo ${GITHUB_REF#refs/heads/} | tr / -)"

        - name: Extract commit hash
            id: extract_commit
            run: echo "::set-output name=commit::$(echo ${GITHUB_SHA::7})"

        - name: Build and tag Docker image
            run: |
                docker build -t fearless/tickets:${{ steps.extract_branch.outputs.branch }}-${{ steps.extract_commit.outputs.commit }} .
                # docker push my-docker-repo/my-image:${{ steps.extract_branch.outputs.branch }}-${{ steps.extract_commit.outputs.commit }}
                IMAGE_ID=$(docker images fearless/tickets:${{ steps.extract_branch.outputs.branch }}-${{ steps.extract_commit.outputs.commit }} --format "{{.ID}}")
                IMAGE_SIZE=$(docker images fearless/tickets:${{ steps.extract_branch.outputs.branch }}-${{ steps.extract_commit.outputs.commit }} --format "{{.Size}}")
                echo "Docker image size: $IMAGE_SIZE"